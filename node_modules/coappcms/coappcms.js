ejs= require("ejs");
markdown = require("github-flavored-markdown");
fs = require('fs');
util = require('util');
path = require('path');
E=require("enumerable"); 
   
var cms= {};

if (typeof exports === "object") {
    cms = exports;
    cms.config = null;
    
    cms.setConfig = function( config ) {
        cms.config = config;
    }
    
    /// Our cms.include function acts as a <>.html.md.ejs filter.
    cms.include = function(file, templateData) {
        file = path.join( cms.config.includePath , file );
        if( path.existsSync(file) ) {
            var filecontent = fs.readFileSync(file,encoding='utf8');
            filecontent = ejs.render(filecontent, templateData);
            return cms.markdown(filecontent);
        }
        return "INCLUDE FAIL: ["+file+"] does not exist";
    };
    
    cms.markdown = function( filecontent ) {
        // handle my custom anchors
        // [text](!id)
        filecontent = filecontent.replace(/\[(.*?)\]\(\!(.*?)\)/gi , '<a id="$2" href="#$2">$1</a>' );
        
        // handle my custom image inserts
        // @[text](url)
        filecontent = filecontent.replace(/@\[(.*?)\]\((.*?)\)/gi , '<p style="background:none repeat scroll 0 0; padding:0.4em; margin-bottom:0.6em; overflow:auto; -moz-border-radius:6px; -webkit-border-radius:6px; border-radius:6px;"><img src="$2" title="$1" alt="$1" /></p>' );
        
        // handle my custom video inserts
        // %[width,height,posterimageurl,mp4url,webmurl]
        filecontent = filecontent.replace(/%\[\s*(.*)\s*,\s*(.*)\s*,\s*(.*)\s*,\s*(.*)\s*,\s*(.*)\s*\]/gi, 
        '<video width="$1" height="$2" poster="$3" controls="controls" preload="none">' +
        '    <source type="video/mp4" src="$4" />' +
        '    <source type="video/webm" src="$5" />' + 
        '    <object width="$1" height="$2" type="application/x-shockwave-flash" data="/scripts/flashmediaelement.swf">' + 
        '        <param name="movie" value="/scripts/flashmediaelement.swf" />' +
        '        <param name="flashvars" value="controls=true&file=$4" />' + 
        '        <!-- Image as a last resort -->' +
        '        <img src="$3" width="$1" height="$2" title="No video playback capabilities" />' +
        '    </object>'+ 
        '</video>');
        
        
        filecontent = markdown.parse( filecontent );
        
        return filecontent.replace("Â @", "@");
    }
}
